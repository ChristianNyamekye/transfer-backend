// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for authentication and profile
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  phone             String?   @unique
  password          String
  firstName         String?
  lastName          String?
  isEmailVerified   Boolean   @default(false)
  isPhoneVerified   Boolean   @default(false)
  kycStatus         KycStatus @default(PENDING)
  profilePicture    String?
  dateOfBirth       DateTime?
  address           String?
  city              String?
  state             String?   // State/Province for KYC
  country           String?
  postalCode        String?
  gender            String?   // 'male', 'female', 'unknown' for Rampnow KYC
  sourceOfFunds     String?   // 'salary', 'business', 'savings', etc. for Rampnow KYC
  expectedAnnualTradeVolume String? // '<10000', '10000-50000', etc. for Rampnow KYC
  isPoliticallyExposed Boolean @default(false) // PEP status for Rampnow KYC
  rampnowKycShared Boolean @default(false) // Track if KYC shared with Rampnow via Hosted Mode
  rampnowCustomerUid String? // Rampnow customer ID after KYC share
  
  // Circle API integration
  circleCustomerId  String?   @unique
  circleWalletId    String?   @unique
  circleKycStatus   String?   // Circle KYC status
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  sessions          UserSession[]
  wallets           Wallet[]
  transactions      Transaction[]
  kycDocuments      KycDocument[]
  bankAccounts      BankAccount[]
  onrampTransactions OnrampTransaction[]
  offrampTransactions OfframpTransaction[]
  
  @@map("users")
}

// User session management for JWT tokens
model UserSession {
  id           String    @id @default(cuid())
  userId       String
  refreshToken String    @unique
  deviceInfo   String?
  ipAddress    String?
  isActive     Boolean   @default(true)
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  
  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_sessions")
}

// Multi-currency wallet system
model Wallet {
  id               String            @id @default(cuid())
  userId           String
  currency         Currency
  balance          Decimal           @default(0)
  availableBalance Decimal           @default(0)
  reservedBalance  Decimal           @default(0)
  isActive         Boolean           @default(true)
  
  // Circle wallet integration
  circleWalletId   String?           @unique
  circleAddress    String?           // Blockchain address
  circleChain      String?           // Blockchain network (ETH, POLY, etc.)
  circleStatus     String?           // Circle wallet status
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  
  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions     Transaction[]
  onrampTransactions OnrampTransaction[]
  offrampTransactions OfframpTransaction[]
  
  @@unique([userId, currency])
  @@map("wallets")
}

// Bank account management
model BankAccount {
  id                String      @id @default(cuid())
  userId            String
  
  // Bank account details
  accountNumber     String
  routingNumber     String?
  bankName          String
  accountType       String      // CHECKING, SAVINGS
  accountHolderName String
  
  // Circle integration
  circleBankId      String?     @unique
  circleStatus      String?     // PENDING, VERIFIED, FAILED
  
  // Verification status
  isVerified        Boolean     @default(false)
  verificationMethod String?    // MICRO_DEPOSITS, INSTANT
  verificationDate  DateTime?
  
  // Metadata
  isActive          Boolean     @default(true)
  isPrimary         Boolean     @default(false)
  nickname          String?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  onrampTransactions OnrampTransaction[]
  offrampTransactions OfframpTransaction[]
  
  @@map("bank_accounts")
}

// Onramp transactions (Bank → USDC)
model OnrampTransaction {
  id                String      @id @default(cuid())
  userId            String
  bankAccountId     String
  walletId          String      // Target wallet for USDC
  
  // Transaction details
  amount            Decimal
  currency          String      // Bank account currency
  usdcAmount        Decimal     // USDC received
  fee               Decimal     @default(0)
  exchangeRate      Decimal     @default(1)
  
  // Circle integration
  circleTransferId  String?     @unique
  circleStatus      String?
  
  // Status tracking
  status            TransactionStatus @default(PENDING)
  reference         String      @unique @default(cuid())
  description       String?
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  completedAt       DateTime?
  
  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccount       BankAccount @relation(fields: [bankAccountId], references: [id])
  wallet            Wallet      @relation(fields: [walletId], references: [id])
  statusHistory     OnrampStatusHistory[]
  
  @@map("onramp_transactions")
}

// Offramp transactions (USDC → Bank)
model OfframpTransaction {
  id                String      @id @default(cuid())
  userId            String
  bankAccountId     String
  walletId          String      // Source wallet with USDC
  
  // Transaction details
  usdcAmount        Decimal     // USDC sent
  amount            Decimal     // Amount received in bank currency
  currency          String      // Bank account currency
  fee               Decimal     @default(0)
  exchangeRate      Decimal     @default(1)
  
  // Circle integration
  circleTransferId  String?     @unique
  circleStatus      String?
  
  // Status tracking
  status            TransactionStatus @default(PENDING)
  reference         String      @unique @default(cuid())
  description       String?
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  completedAt       DateTime?
  
  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccount       BankAccount @relation(fields: [bankAccountId], references: [id])
  wallet            Wallet      @relation(fields: [walletId], references: [id])
  statusHistory     OfframpStatusHistory[]
  
  @@map("offramp_transactions")
}

// Status history for onramp transactions
model OnrampStatusHistory {
  id              String            @id @default(cuid())
  transactionId   String
  status          TransactionStatus
  message         String
  metadata        Json?
  createdAt       DateTime          @default(now())
  
  // Relations
  transaction     OnrampTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@map("onramp_status_history")
}

// Status history for offramp transactions
model OfframpStatusHistory {
  id              String             @id @default(cuid())
  transactionId   String
  status          TransactionStatus
  message         String
  metadata        Json?
  createdAt       DateTime           @default(now())
  
  // Relations
  transaction     OfframpTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@map("offramp_status_history")
}

// Transaction records
model Transaction {
  id                    String            @id @default(cuid())
  userId                String
  walletId              String
  type                  TransactionType
  status                TransactionStatus @default(PENDING)
  
  // Amount details
  amount                Decimal
  currency              Currency
  fee                   Decimal           @default(0)
  exchangeRate          Decimal?
  
  // Recipient details (for transfers)
  recipientName         String?
  recipientEmail        String?
  recipientPhone        String?
  recipientBankName     String?
  recipientAccountNumber String?
  recipientRoutingNumber String?
  recipientSwiftCode    String?
  recipientAddress      String?
  recipientCurrency     Currency?
  
  // Payment method and processing
  paymentMethod         PaymentMethod?
  externalTransactionId String?
  blockchainTxHash      String?
  
  // Circle API integration
  circleTransferId      String?   @unique
  circleStatus          String?   // Circle transfer status
  
  // Metadata
  reference             String            @unique @default(cuid())
  description           String?
  metadata              Json?
  
  // Timestamps
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  completedAt           DateTime?
  
  // Relations
  user                  User              @relation(fields: [userId], references: [id])
  wallet                Wallet            @relation(fields: [walletId], references: [id])
  statusHistory         TransactionStatusHistory[]
  
  @@map("transactions")
}

// Transaction status history for tracking
model TransactionStatusHistory {
  id            String            @id @default(cuid())
  transactionId String
  status        TransactionStatus
  message       String?
  metadata      Json?
  createdAt     DateTime          @default(now())
  
  // Relations
  transaction   Transaction       @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@map("transaction_status_history")
}

// KYC document storage
model KycDocument {
  id           String      @id @default(cuid())
  userId       String
  documentType DocumentType
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  status       KycDocumentStatus @default(PENDING)
  rejectionReason String?
  uploadedAt   DateTime    @default(now())
  reviewedAt   DateTime?
  
  // Relations
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("kyc_documents")
}

// Exchange rates for currency conversion
model ExchangeRate {
  id        String   @id @default(cuid())
  fromCurrency Currency
  toCurrency   Currency
  rate      Decimal
  source    String   @default("api")
  timestamp DateTime @default(now())
  
  @@unique([fromCurrency, toCurrency, timestamp])
  @@map("exchange_rates")
}

// Enums
enum KycStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum Currency {
  USD
  USDC  // USD Coin for bridge liquidity
  NGN
  KES
  GHS
  ZAR
  GBP
  EUR
  CAD
  AUD
  JPY
  CHF
  CNY
  INR
  BRL
  MXN
  SGD
  HKD
  NZD
  SEK
  NOK
  KRW
  THB
  PHP
  IDR
  MYR
  EGP
  MAD
  TND
  ETB
  UGX
  TZS
  XOF
  XAF
  RWF
  MZN
  AED
  SAR
  BWP
  ZMW
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER_SEND
  TRANSFER_RECEIVE
  EXCHANGE
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
  CRYPTO
  ACH
  WIRE
}

enum DocumentType {
  PASSPORT
  NATIONAL_ID
  DRIVERS_LICENSE
  PROOF_OF_ADDRESS
  SELFIE
}

enum KycDocumentStatus {
  PENDING
  APPROVED
  REJECTED
}
